{"version":3,"file":"did-pan.js","sources":["../../src/modifiers/did-pan.js"],"sourcesContent":["import Modifier from 'ember-modifier';\nimport {\n  parseInitialTouchData,\n  parseTouchData,\n  isHorizontal,\n  isVertical,\n} from '../utils/parse-touch-data.js';\nimport { action } from '@ember/object';\nimport { registerDestructor } from '@ember/destroyable';\n\nconst _fn = () => {};\n\nfunction cleanup(instance) {\n  instance.removeEventListeners();\n  instance.currentTouches.clear();\n  instance.element = undefined;\n}\n\nexport default class DidPanModifier extends Modifier {\n  element;\n  threshold;\n  axis;\n  capture;\n  preventScroll;\n  pointerTypes;\n  currentTouches = new Map();\n  dragging = false;\n\n  constructor(owner, args) {\n    super(owner, args);\n    registerDestructor(this, cleanup);\n  }\n\n  modify(element, positional, named) {\n    this.removeEventListeners();\n\n    this.element = element;\n\n    this.threshold = named.threshold ?? 10;\n    this.axis = named.axis ?? 'horizontal';\n    this.capture = named.capture ?? false;\n    this.preventScroll = named.preventScroll ?? true;\n    this.pointerTypes = named.pointerTypes ?? ['touch'];\n\n    this.didPanStart = named.onPanStart ?? _fn;\n    this.didPan = named.onPan ?? _fn;\n    this.didPanEnd = named.onPanEnd ?? _fn;\n\n    this.addEventListeners();\n  }\n\n  addEventListeners() {\n    // By default, CSS rule `touch-action` is `auto`, enabling panning on both directions.\n    // We override panning on a given direction, so we need to disable default browser behavior\n    // on that diretion, but we need to keep the other direction pannable.\n    // Thus, we set `touch-action` to `pan-y` when we pan horizontally and vice versa.\n    if (this.axis === 'horizontal') {\n      this.element.style.touchAction = 'pan-y';\n    } else if (this.axis === 'vertical') {\n      this.element.style.touchAction = 'pan-x';\n    } else if (this.axis === 'both') {\n      this.element.style.touchAction = 'none';\n    }\n\n    this.element.addEventListener('pointerdown', this.didTouchStart, {\n      capture: this.capture,\n      passive: true,\n    });\n    document.addEventListener('pointermove', this.documentPointerMove, {\n      capture: this.capture,\n      passive: !this.preventScroll,\n    });\n    document.addEventListener('pointercancel', this.documentPointerUp, {\n      capture: this.capture,\n      passive: true,\n    });\n    document.addEventListener('pointerup', this.documentPointerUp, {\n      capture: this.capture,\n      passive: true,\n    });\n  }\n\n  removeEventListeners() {\n    if (this.element) {\n      this.element.style.touchAction = null;\n\n      this.element.removeEventListener('pointerdown', this.didTouchStart, {\n        capture: this.capture,\n        passive: true,\n      });\n    }\n    document.removeEventListener('pointermove', this.documentPointerMove, {\n      capture: this.capture,\n      passive: !this.preventScroll,\n    });\n    document.removeEventListener('pointercancel', this.documentPointerUp, {\n      capture: this.capture,\n      passive: true,\n    });\n    document.removeEventListener('pointerup', this.documentPointerUp, {\n      capture: this.capture,\n      passive: true,\n    });\n  }\n\n  @action\n  didTouchStart(e) {\n    if (!this.dragging && this.pointerTypes.includes(e.pointerType)) {\n      const touchData = parseInitialTouchData(e);\n      this.currentTouches.set(e.pointerId, touchData);\n\n      this.dragging = true;\n    }\n  }\n\n  @action\n  documentPointerMove(e) {\n    if (this.dragging && this.pointerTypes.includes(e.pointerType)) {\n      this.handlePointerMove(e);\n    }\n  }\n\n  @action\n  documentPointerUp(e) {\n    if (this.dragging && this.pointerTypes.includes(e.pointerType)) {\n      this.handlePointerEnd(e);\n    }\n  }\n\n  @action\n  handlePointerMove(e) {\n    if (this.dragging && this.currentTouches.has(e.pointerId)) {\n      const previousTouchData = this.currentTouches.get(e.pointerId);\n      const touchData = parseTouchData(previousTouchData, e);\n\n      if (touchData.panStarted) {\n        // prevent scroll if a pan is still busy\n        if (this.preventScroll) {\n          e.preventDefault();\n        }\n\n        this.didPan(touchData.data);\n      } else {\n        // only pan when the threshold for the given axis is achieved\n        if (\n          !touchData.panDenied &&\n          ((this.axis === 'horizontal' &&\n            Math.abs(touchData.data.current.distanceX) > this.threshold) ||\n            (this.axis === 'vertical' &&\n              Math.abs(touchData.data.current.distanceY) > this.threshold) ||\n            (this.axis === 'both' &&\n              Math.abs(touchData.data.current.distance) > this.threshold))\n        ) {\n          // test if axis matches with data else deny the pan\n          if (\n            (this.axis === 'horizontal' && isHorizontal(touchData)) ||\n            (this.axis === 'vertical' && isVertical(touchData)) ||\n            this.axis === 'both'\n          ) {\n            // prevent scroll if a pan is detected\n            if (this.preventScroll) {\n              e.preventDefault();\n            }\n\n            touchData.panStarted = true;\n\n            // trigger panStart hook\n            this.didPanStart(touchData.data);\n          } else {\n            touchData.panDenied = true;\n          }\n        }\n      }\n\n      this.currentTouches.set(e.pointerId, touchData);\n    }\n  }\n\n  @action\n  handlePointerEnd(e) {\n    if (this.dragging && this.currentTouches.has(e.pointerId)) {\n      this.dragging = false;\n\n      const previousTouchData = this.currentTouches.get(e.pointerId);\n      const touchData = parseTouchData(previousTouchData, e);\n\n      if (touchData.panStarted) {\n        this.didPanEnd(touchData.data);\n      }\n\n      this.currentTouches.delete(e.pointerId);\n    }\n  }\n}\n"],"names":["_fn","cleanup","instance","removeEventListeners","currentTouches","clear","element","undefined","DidPanModifier","Modifier","threshold","axis","capture","preventScroll","pointerTypes","Map","dragging","constructor","owner","args","registerDestructor","modify","positional","named","didPanStart","onPanStart","didPan","onPan","didPanEnd","onPanEnd","addEventListeners","style","touchAction","addEventListener","didTouchStart","passive","document","documentPointerMove","documentPointerUp","removeEventListener","e","includes","pointerType","touchData","parseInitialTouchData","set","pointerId","n","prototype","action","handlePointerMove","handlePointerEnd","has","previousTouchData","get","parseTouchData","panStarted","preventDefault","data","panDenied","Math","abs","current","distanceX","distanceY","distance","isHorizontal","isVertical","delete"],"mappings":"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"}